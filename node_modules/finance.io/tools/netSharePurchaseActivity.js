'use strict';

const request = require('request');

const getUrl = (symbol, extension) => {
    if (extension === undefined || extension === '') {
        extension = '';
    } else {
        extension = `.${extension}`;
    }
    let url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}${extension}?&modules=netSharePurchaseActivity`;
    return url;
};

const getJson = url =>
    new Promise((resolve, reject) => {
        let requestOpts = {
            url: url,
            json: true,
            headers: { 'User-agent': 'request' },
        };

        request.get(requestOpts, (err, res, data) => {
            if (err) {
                reject(err);
            } else if (res.statusCode !== 200) {
                reject(res.statusCode);
            } else {
                resolve(data);
            }
        });
    });

const nspa = (symbol, extension) =>
    new Promise((resolve, reject) => {
        let url = getUrl(symbol, extension);
        getJson(url)
            .then(data => {
              const dt = data.quoteSummary.result[0].netSharePurchaseActivity 
                resolve({
                    symbol,
                    data : "Net Share Purchase Activity",
                 buyInfoCount: dt.buyInfoCount.raw, buyInfoShares : dt.buyInfoShares.raw, buyPercentInsiderShares : dt.buyPercentInsiderShares.raw, sellInfoCount : dt.sellInfoCount.raw, sellInfoShares: dt.sellInfoShares.raw, netInfoCount : dt.netInfoCount.raw, netInfoShares : dt.netInfoShares.raw, netPercentInsiderShares: dt.netPercentInsiderShares.raw, totalInsiderShares : dt.totalInsiderShares.raw,
                });
            })
            .catch(err => {
                reject(err);
            });
    });

module.exports = nspa